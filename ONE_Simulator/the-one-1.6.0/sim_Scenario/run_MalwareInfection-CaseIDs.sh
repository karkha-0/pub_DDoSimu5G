#!/bin/bash

# Move up one directory to ensure correct execution
cd "$(dirname "$0")/.."

# List of configuration files
CONFIG_FILES=(
	"sim_Scenario/CaseIDs/MalwareInfection-CaseIDs/D2D_GAM.txt" 
	"sim_Scenario/CaseIDs/MalwareInfection-CaseIDs/D2D_RWP.txt" 
	#"sim_Scenario/CaseIDs/MalwareInfection-CaseIDs/Epd_GAM.txt" 
	#"sim_Scenario/CaseIDs/MalwareInfection-CaseIDs/Epd_RWP.txt"
)

# Base output directory
OUTPUT_DIR="sim_Scenario/simulation_results_MalwareInfection"

# Ensure output directory exists
mkdir -p $OUTPUT_DIR

# Number of runs per configuration
NUM_RUNS=10

# Loop through each configuration file
for CONFIG in "${CONFIG_FILES[@]}"; do
    # Extract scenario name from file
    SCENARIO_NAME=$(basename "$CONFIG" .txt)

    # Create scenario-specific directory
    SCENARIO_DIR="$OUTPUT_DIR/$SCENARIO_NAME"
    mkdir -p "$SCENARIO_DIR"

    # Extract the report directory from the config file
    REPORT_DIR=$(grep -E "^Report.reportDir" "$CONFIG" | cut -d '=' -f2 | tr -d ' ')

    # Run the simulation 10 times with different seeds
    for i in $(seq 1 $NUM_RUNS); do
        echo "Running $SCENARIO_NAME - Run $i"

	# Generate a random seed between 1 and 99999999999
	SEED=$(( 1 + RANDOM % 999999999 ))
	echo "Seed is $SEED - Run $i"

        # Create a modified config file with the new seed
        CONFIG_COPY="$SCENARIO_DIR/${SCENARIO_NAME}_run${i}.txt"
        sed "s/MovementModel.rngSeed = [0-9]*/MovementModel.rngSeed = $SEED/" "$CONFIG" > "$CONFIG_COPY"

        # Run the simulator with the modified config (replace "your_simulator_command" with actual command)
        ./one_noGUI.sh "$CONFIG_COPY"

	# Only move the report contents if the simulation finished successfully
        if [ $? -eq 0 ]; then
            if [ -d "$REPORT_DIR" ]; then
                # Create a run-specific report folder
                RUN_REPORT_DIR="$SCENARIO_DIR/run_${i}_reports"
                mkdir -p "$RUN_REPORT_DIR"

                # Move only the contents inside the REPORT_DIR
                mv "$REPORT_DIR"/* "$RUN_REPORT_DIR"/ 2>/dev/null

                echo "Reports moved for $SCENARIO_NAME - Run $i"
            else
                echo "Warning: No reports found in $REPORT_DIR for $SCENARIO_NAME - Run $i"
            fi
        else
            echo "Error: Simulation failed for $SCENARIO_NAME - Run $i, reports not moved!"
        fi

    done
done

echo "All simulations completed!"
